package com.example.tests;

import com.example.pages.AnyAppPage;
import org.testng.Assert;
import org.testng.SkipException;
import org.testng.annotations.Test;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import com.example.pages.AppiumUnavailableException;

public class AnyAppOpenTest {
    private static final Logger logger = LogManager.getLogger(AnyAppOpenTest.class);
    
    @Test(description = "Тест открытия калькулятора на устройстве")
    public void openCalculatorOnDevice() {
        try {
            String deviceName = getDeviceName();
            // Для Samsung калькулятор:
            String appPackage = "com.sec.android.app.calculator";
            String appActivity = "com.sec.android.app.calculator.Calculator";
            
            AnyAppPage appPage = new AnyAppPage();
            boolean result = appPage.openApp(deviceName, appPackage, appActivity);
            Assert.assertTrue(result, "Не удалось открыть калькулятор. Проверьте, установлен ли калькулятор на устройстве.");
            appPage.quit();
        } catch (AppiumUnavailableException e) {
            logger.warn("Appium/Device unavailable: " + e.getMessage());
            throw new SkipException("Appium/Device unavailable: " + e.getMessage());
        } catch (Exception e) {
            logger.error("Calculator test failed", e);
            throw new SkipException("Appium/Device error: " + e.getMessage());
        }
    }
    
    private String getDeviceName() {
        try {
            Process proc = Runtime.getRuntime().exec("adb devices");
            java.io.BufferedReader reader = new java.io.BufferedReader(new java.io.InputStreamReader(proc.getInputStream()));
            String line;
            while ((line = reader.readLine()) != null) {
                if (line.endsWith("\tdevice")) {
                    return line.split("\t")[0];
                }
            }
        } catch (Exception e) {
            logger.warn("Не удалось получить deviceName из adb: " + e.getMessage());
        }
        return "Android Device";
    }
} 